
# Архитектура приложения Simple Photo Editor

Этот документ описывает архитектуру приложения Simple Photo Editor, созданного с использованием Python и PyQt5.

## Обзор

Simple Photo Editor — это приложение с многодокументным интерфейсом (MDI), предназначенное для редактирования изображений. Оно позволяет пользователям одновременно открывать и работать с несколькими файлами изображений в отдельных дочерних окнах. Архитектура является модульной, что обеспечивает четкое разделение ответственности между различными компонентами.

## Ключевые компоненты

Архитектура приложения состоит из следующих основных модулей:

- **`main.py`**: Точка входа приложения.
- **`main_window.py`**: Основное окно приложения.
- **`editor.py`**: Основной компонент для редактирования изображений.
- **`scene.py`**: Сцена для взаимодействия с изображением.
- **`commands.py`**: Реализация паттерна "Команда" для функций отмены/повтора.
- **`widgets.py`**: Пользовательские виджеты, используемые в приложении.
- **`utils.py`**: Вспомогательные функции.

### `main.py`

Это главный скрипт, который запускает приложение. Его обязанности включают:
- Инициализацию `QApplication`.
- Загрузку конфигурации с помощью `utils.load_config()`.
- Создание экземпляра `MainWindow`.
- Отображение главного окна.
- Сохранение конфигурации при выходе.

### `main_window.py`

Этот модуль определяет класс `MainWindow`, который наследуется от `QMainWindow`. Он отвечает за основной пользовательский интерфейс, включая:
- **MDI Area (`QMdiArea`)**: Центральный виджет, который содержит дочерние окна для каждого открытого изображения.
- **Menus and Toolbars**: Создание и управление меню и панелями инструментов.
- **Actions (`QAction`)**: Определение действий для всех операций, таких как "Открыть", "Сохранить", "Вырезать", "Копировать", "Вставить" и т.д.
- **Event Handling**: Обработка событий, таких как закрытие окна, и управление сохранением несохраненных изменений.
- **Dialogs**: Отображение диалоговых окон для таких операций, как создание нового изображения, изменение размера и настройка.

### `editor.py`

Этот модуль содержит ядро функциональности редактирования изображений.
- **`ImageEditor`**: Класс, унаследованный от `QGraphicsView`, который отображает изображение. Он управляет масштабированием, прокруткой и другими взаимодействиями с видом.
- **`EditorContainer`**: Виджет, который содержит `ImageEditor` и линейки (`RulerWidget`). Он управляет компоновкой редактора и линеек.

### `scene.py`

Этот модуль реализует `ImageEditorScene`, который наследуется от `QGraphicsScene`. Он отвечает за управление содержимым, отображаемым в `ImageEditor`.
- **Image Display**: Отображение основного изображения с помощью `QGraphicsPixmapItem`.
- **Selection**: Обработка создания, изменения размера и перемещения прямоугольника выделения.
- **Movable Items**: Управление вставленными изображениями как подвижными элементами (`MovableImageItem`).

### `commands.py`

Этот модуль реализует паттерн "Команда", который инкапсулирует все операции, изменяющие изображение. Это позволяет реализовать функции отмены и повтора.
- **`Command`**: Базовый класс для всех команд с методами `execute()`, `undo()` и `redo()`.
- **Конкретные классы команд**:
    - `CropCommand`: Обрезает изображение.
    - `AdjustmentsCommand`: Применяет коррекцию яркости, контрастности и гаммы.
    - `TransformCommand`: Выполняет операции поворота и отражения.
    - `GrayscaleCommand`: Преобразует изображение в оттенки серого.
    - `PasteCommand`: Вставляет изображение из буфера обмена.
    - `CutCommand`: Вырезает выделенную область.
    - `ResizeCommand`: Изменяет размер изображения.

### `widgets.py`

Этот модуль содержит различные пользовательские виджеты, используемые в приложении:
- **`RulerWidget`**: Отображает горизонтальные и вертикальные линейки рядом с редактором изображений.
- **`CustomMdiSubWindow`**: Пользовательское дочернее окно MDI, которое содержит `EditorContainer`.
- **Dialogs**:
    - `NewImageDialog`: Диалоговое окно для создания нового изображения с указанными размерами.
    - `AdjustmentsDialog`: Диалоговое окно для настройки яркости, контрастности и гаммы.
    - `ResizeDialog`: Диалоговое окно для изменения размера изображения.
    - `RotationDialog`: Диалоговое окно для точного поворота изображения.

### `utils.py`

Этот модуль предоставляет вспомогательные функции, используемые в приложении:
- **`load_config()` и `save_config()`**: Функции для чтения и записи настроек приложения в файл `config.ini`.
- **`resource_path()`**: Функция для получения абсолютного пути к ресурсам, что полезно как для разработки, так и для упакованных приложений.
- **`add_recent_file()` и `get_recent_files()`**: Функции для управления списком недавно открытых файлов.

## Паттерны проектирования

- **Model-View-Controller (MVC)**: Хотя и не строго реализован, архитектура следует принципам MVC:
    - **Модель**: `QImage` представляет данные изображения.
    - **Представление**: `ImageEditor` (`QGraphicsView`) и `ImageEditorScene` (`QGraphicsScene`) отображают модель.
    - **Контроллер**: `MainWindow` и различные диалоги обрабатывают ввод пользователя и обновляют модель и представление.
- **Command Pattern**: Используется для инкапсуляции операций, что позволяет реализовать функции отмены и повтора. Каждое действие, изменяющее изображение, является командой.
- **Multi-Document Interface (MDI)**: Позволяет пользователям работать с несколькими изображениями одновременно в одном окне приложения.

## Поток данных

1. **Открытие изображения**:
   - Пользователь инициирует действие "Открыть".
   - `MainWindow` открывает `QFileDialog`.
   - После выбора файла `MainWindow` создает новое `CustomMdiSubWindow`.
   - `ImageEditor` в дочернем окне загружает и отображает изображение.

2. **Редактирование изображения**:
   - Пользователь выполняет действие (например, обрезку, поворот).
   - `MainWindow` или соответствующий диалог создает экземпляр конкретной команды (например, `CropCommand`).
   - Команда выполняется, изменяя `QImage`.
   - `ImageEditor` обновляет отображение, чтобы отразить изменения.
   - Команда помещается в стек отмены.

3. **Отмена/Повтор**:
   - Пользователь инициирует действие "Отмена" или "Повтор".
   - `MainWindow` вызывает метод `undo()` или `redo()` в `ImageEditor`.
   - `ImageEditor` извлекает последнюю команду из стека отмены/повтора и вызывает ее метод `undo()` или `redo()`.
   - Команда восстанавливает предыдущее состояние изображения.
   - `ImageEditor` обновляет отображение.

## Заключение

Архитектура Simple Photo Editor является модульной и расширяемой. Использование паттерна "Команда" обеспечивает надежную функциональность отмены/повтора, а структура MDI позволяет эффективно работать с несколькими файлами. Четкое разделение ответственности между компонентами облегчает сопровождение и добавление новых функций.
